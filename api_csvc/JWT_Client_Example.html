<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT API Client Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .token-info {
            word-break: break-all;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>JWT API Client Example</h1>
    
    <!-- Login Section -->
    <div class="container">
        <h2>1. Đăng nhập</h2>
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" value="admin" placeholder="Nhập username">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" value="password123" placeholder="Nhập password">
        </div>
        <button onclick="login()">Đăng nhập</button>
        <div id="loginResponse" class="response"></div>
    </div>

    <!-- Google Login Section -->
    <div class="container">
        <h2>2. Đăng nhập Google</h2>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" value="user@example.com" placeholder="Nhập email">
        </div>
        <button onclick="loginWithGoogle()">Đăng nhập Google</button>
        <div id="googleLoginResponse" class="response"></div>
    </div>

    <!-- Token Info Section -->
    <div class="container">
        <h2>3. Thông tin Token</h2>
        <div id="tokenInfo" class="token-info">Chưa có token</div>
        <button onclick="validateToken()">Validate Token</button>
        <button onclick="refreshToken()">Refresh Token</button>
        <button onclick="clearToken()">Clear Token</button>
        <div id="tokenResponse" class="response"></div>
    </div>

    <!-- Profile Section -->
    <div class="container">
        <h2>4. Lấy thông tin Profile</h2>
        <button onclick="getProfile()" id="profileBtn">Lấy Profile</button>
        <div id="profileResponse" class="response"></div>
    </div>

    <!-- Admin Section -->
    <div class="container">
        <h2>5. Admin Functions (Chỉ Admin mới truy cập được)</h2>
        <button onclick="getAdminAccounts()" id="adminBtn">Lấy danh sách tài khoản</button>
        <div id="adminResponse" class="response"></div>
        
        <h3>Update Account</h3>
        <div class="form-group">
            <label for="updateAccountId">Account ID:</label>
            <input type="number" id="updateAccountId" value="1" placeholder="ID tài khoản">
        </div>
        <div class="form-group">
            <label for="updateRole">Role:</label>
            <input type="text" id="updateRole" value="Admin" placeholder="Tên role">
        </div>
        <button onclick="updateAccount()">Update Account</button>
        <div id="updateResponse" class="response"></div>
    </div>

    <script>
        // API Base URL
        const API_BASE = '/api/v1';
        
        // Token storage
        let currentToken = localStorage.getItem('jwt_token');
        updateTokenDisplay();

        // Utility functions
        function updateTokenDisplay() {
            const tokenInfo = document.getElementById('tokenInfo');
            if (currentToken) {
                tokenInfo.innerHTML = `<strong>Token:</strong> ${currentToken.substring(0, 50)}...`;
                updateButtonStates(true);
            } else {
                tokenInfo.innerHTML = 'Chưa có token';
                updateButtonStates(false);
            }
        }

        function updateButtonStates(hasToken) {
            document.getElementById('profileBtn').disabled = !hasToken;
            document.getElementById('adminBtn').disabled = !hasToken;
        }

        function displayResponse(elementId, response, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(response, null, 2);
            element.className = `response ${isSuccess ? 'success' : 'error'}`;
        }

        async function makeApiCall(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(currentToken && { 'Authorization': `Bearer ${currentToken}` }),
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                
                if (response.status === 401) {
                    // Token expired or invalid
                    currentToken = null;
                    localStorage.removeItem('jwt_token');
                    updateTokenDisplay();
                }

                return { data, status: response.status, ok: response.ok };
            } catch (error) {
                return { data: { message: error.message, success: false }, status: 500, ok: false };
            }
        }

        // Authentication functions
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const result = await makeApiCall('/jwt-dang-nhap', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (result.data.success && result.data.token) {
                currentToken = result.data.token;
                localStorage.setItem('jwt_token', currentToken);
                updateTokenDisplay();
            }

            displayResponse('loginResponse', result.data, result.data.success);
        }

        async function loginWithGoogle() {
            const email = document.getElementById('email').value;

            const result = await makeApiCall('/jwt-login-with-google', {
                method: 'POST',
                body: JSON.stringify({ email })
            });

            if (result.data.success && result.data.token) {
                currentToken = result.data.token;
                localStorage.setItem('jwt_token', currentToken);
                updateTokenDisplay();
            }

            displayResponse('googleLoginResponse', result.data, result.data.success);
        }

        // Token management functions
        async function validateToken() {
            if (!currentToken) {
                displayResponse('tokenResponse', { message: 'Không có token', success: false }, false);
                return;
            }

            const result = await makeApiCall('/jwt-validate-token', {
                method: 'POST',
                body: JSON.stringify({ token: currentToken })
            });

            displayResponse('tokenResponse', result.data, result.data.success);
        }

        async function refreshToken() {
            if (!currentToken) {
                displayResponse('tokenResponse', { message: 'Không có token để refresh', success: false }, false);
                return;
            }

            const result = await makeApiCall('/jwt-refresh-token', {
                method: 'POST'
            });

            if (result.data.success && result.data.token) {
                currentToken = result.data.token;
                localStorage.setItem('jwt_token', currentToken);
                updateTokenDisplay();
            }

            displayResponse('tokenResponse', result.data, result.data.success);
        }

        function clearToken() {
            currentToken = null;
            localStorage.removeItem('jwt_token');
            updateTokenDisplay();
            displayResponse('tokenResponse', { message: 'Token đã được xóa', success: true });
        }

        // Protected API calls
        async function getProfile() {
            const result = await makeApiCall('/jwt-profile', {
                method: 'GET'
            });

            displayResponse('profileResponse', result.data, result.data.success);
        }

        async function getAdminAccounts() {
            const result = await makeApiCall('/jwt-admin-accounts', {
                method: 'GET'
            });

            displayResponse('adminResponse', result.data, result.data.success);
        }

        async function updateAccount() {
            const id_account = parseInt(document.getElementById('updateAccountId').value);
            const ten_role = document.getElementById('updateRole').value;

            const result = await makeApiCall('/jwt-update-account', {
                method: 'POST',
                body: JSON.stringify({ id_account, ten_role })
            });

            displayResponse('updateResponse', result.data, result.data.success);
        }

        // Auto-refresh token every 30 minutes
        setInterval(async () => {
            if (currentToken) {
                console.log('Auto-refreshing token...');
                await refreshToken();
            }
        }, 30 * 60 * 1000); // 30 minutes
    </script>
</body>
</html> 